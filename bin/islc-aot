#!/usr/bin/env sh
set -eu

SCRIPT_DIR=$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)
ROOT_DIR=$(CDPATH= cd -- "$SCRIPT_DIR/.." && pwd)

PROFILE=extended
OUT_BIN=a.out
KEEP_LL=0
LL_PATH=
OPT_LEVEL=0
OPT_PRESET=
INPUTS=

while [ "$#" -gt 0 ]; do
  case "$1" in
    --profile)
      shift
      [ "$#" -gt 0 ] || { echo "--profile requires strict|extended" >&2; exit 2; }
      PROFILE="$1"
      ;;
    --profile=*)
      PROFILE=${1#--profile=}
      ;;
    -o)
      shift
      [ "$#" -gt 0 ] || { echo "-o requires output path" >&2; exit 2; }
      OUT_BIN="$1"
      ;;
    --emit-ll)
      shift
      [ "$#" -gt 0 ] || { echo "--emit-ll requires path" >&2; exit 2; }
      LL_PATH="$1"
      KEEP_LL=1
      ;;
    --opt-level)
      shift
      [ "$#" -gt 0 ] || { echo "--opt-level requires 0|1|2|3|s|z" >&2; exit 2; }
      OPT_LEVEL="$1"
      ;;
    --opt-level=*)
      OPT_LEVEL=${1#--opt-level=}
      ;;
    --opt-preset)
      shift
      [ "$#" -gt 0 ] || { echo "--opt-preset requires none|safe|aggressive" >&2; exit 2; }
      OPT_PRESET="$1"
      ;;
    --opt-preset=*)
      OPT_PRESET=${1#--opt-preset=}
      ;;
    -h|--help)
      echo "Usage: islc-aot [--profile strict|extended] [--opt-level 0|1|2|3|s|z] [--opt-preset none|safe|aggressive] [-o output-bin] [--emit-ll out.ll] <file> [file ...]" >&2
      exit 0
      ;;
    *)
      INPUTS="$INPUTS $1"
      ;;
  esac
  shift
done

if [ -n "$OPT_PRESET" ]; then
  case "$OPT_PRESET" in
    none) OPT_LEVEL=0 ;;
    safe) OPT_LEVEL=2 ;;
    aggressive) OPT_LEVEL=3 ;;
    *) echo "invalid --opt-preset: $OPT_PRESET" >&2; exit 2 ;;
  esac
fi

case "$OPT_LEVEL" in
  0|1|2|3|s|z) ;;
  *) echo "invalid --opt-level: $OPT_LEVEL" >&2; exit 2 ;;
esac

[ -n "$INPUTS" ] || { echo "input file is required" >&2; exit 2; }
command -v clang >/dev/null 2>&1 || { echo "clang not found" >&2; exit 2; }

if [ "$KEEP_LL" -eq 1 ]; then
  TMP_LL="$LL_PATH"
else
  TMP_LL=$(mktemp -t isl_aot_XXXXXX.ll)
fi

# shellcheck disable=SC2086
"$SCRIPT_DIR/islc-llvm" --profile "$PROFILE" --mode aot -o "$TMP_LL" $INPUTS
# Whitelist-oriented defaults: keep numeric/observable semantics stable.
OPT_FLAGS="-fno-fast-math -fno-vectorize -fno-slp-vectorize"
if [ "$OPT_PRESET" = "aggressive" ]; then
  OPT_FLAGS="$OPT_FLAGS -funroll-loops"
fi

# shellcheck disable=SC2086
clang -O"$OPT_LEVEL" $OPT_FLAGS -x ir "$TMP_LL" -x c "$ROOT_DIR/src/isl/compiler/llvm_runtime.c" -o "$OUT_BIN"

if [ "$KEEP_LL" -eq 0 ]; then
  rm -f "$TMP_LL"
fi
