# webserver 実装タスク分解 (v1.0)

対象要件: `examples/webserver/REQUIREMENTS.md` (v1.1)

## 0. 前提と完了定義

- 対応範囲: HTTP/1.1, HTTPS, Linux/FreeBSD, 固定ポート8080, 同時接続100, 設定可能ドキュメントルート, CGI
- 完了定義 (DoD):
  - 全タスクの受け入れ条件を満たす
  - 自動テストが成功する
  - 最低限の運用手順（起動/停止/設定）がドキュメント化される

## 1. タスク一覧（受け入れ条件つき）

### T1. 設定ファイル仕様の確定

- 実装内容:
  - 設定ファイル形式（例: INI/TOML/YAML のいずれか）を確定する
  - 必須キーを定義する: `listen_port`, `document_root`, `tls_cert_file`, `tls_key_file`, `cgi_enabled`, `cgi_bin_dir`, `max_connections`
  - 起動時バリデーション（存在チェック、型チェック、パス正規化）を実装する
- 受け入れ条件:
  - 不正設定で起動した場合、原因が分かるエラーで終了する
  - 正常設定で起動した場合、起動ログに設定反映値（機密除く）が出力される
  - `listen_port=8080` 以外を指定した場合は起動失敗する

### T2. HTTP/1.1 サーバー基盤実装

- 実装内容:
  - TCP 8080 で待ち受ける HTTP/1.1 サーバーを実装する
  - 最低限のメソッド（`GET`, `HEAD`, `POST`）を処理する
  - Keep-Alive の基本挙動と接続クローズ条件を実装する
- 受け入れ条件:
  - `curl` で `GET`/`HEAD`/`POST` が 200 系または想定エラーで応答する
  - HTTP/1.0/1.1 のヘッダ差分に対して破綻しない
  - 不正リクエストに対して 400 を返し、プロセスが落ちない

### T3. HTTPS 対応（TLS終端）

- 実装内容:
  - HTTPS リスナー（8080 上で TLS）を実装する
  - `tls_cert_file`/`tls_key_file` を読み込み、ハンドシェイクを実施する
  - 証明書ロード失敗時の安全な起動失敗を実装する
- 受け入れ条件:
  - `openssl s_client` で接続でき、証明書が提示される
  - HTTPS 経由で静的配信・CGI が動作する
  - 証明書/鍵ファイルが不正な場合、起動失敗し明確なエラーを出力する

### T4. 静的配信（document_root + /public 制約）

- 実装内容:
  - 設定ファイル指定 `document_root` を配信基準ディレクトリとして採用する
  - 配信許可範囲を `document_root/public/*` に限定する
  - パストラバーサル対策（`..`、シンボリックリンク経由逸脱対策）を実装する
  - MIME タイプ判定と `HEAD` 応答で本文省略を実装する
- 受け入れ条件:
  - `document_root/public/index.html` が 200 で配信される
  - `document_root/private/*` へのアクセスは 403 または 404 になる
  - `..` を含むパスは配信されない
  - `HEAD` は `GET` と同じヘッダを返し、本文は空になる

### T5. CGI 実行基盤

- 実装内容:
  - `cgi_enabled=true` 時に CGI 実行ルートを有効化する
  - `cgi_bin_dir` 配下の実行ファイルを CGI として起動する
  - CGI 標準環境変数（`REQUEST_METHOD`, `QUERY_STRING`, `CONTENT_LENGTH`, `CONTENT_TYPE`, `SCRIPT_NAME` 等）を設定する
  - CGI の標準出力を HTTP レスポンスとして返却し、異常終了時の 5xx 応答を実装する
- 受け入れ条件:
  - サンプル CGI が `GET` と `POST` の両方で応答する
  - CGI 実行失敗時に 500 を返し、サーバープロセスは継続稼働する
  - `cgi_bin_dir` 外の実行は拒否される

### T6. 同時接続数制御（最大100）

- 実装内容:
  - 同時接続上限を `max_connections=100` で固定実装する
  - 上限超過時は新規接続を拒否または即時 503 応答する
  - 接続開放漏れ監視（タイムアウト・finally close）を実装する
- 受け入れ条件:
  - 負荷試験で 100 接続までは正常応答を維持する
  - 101 接続目以降は設計どおり拒否される
  - 負荷試験後に接続数カウンタが正常値へ戻る

### T7. OS互換性対応（Linux/FreeBSD）

- 実装内容:
  - Linux/FreeBSD で差異が出る箇所（ソケット、プロセス起動、パス、権限）を吸収する
  - CI もしくは手動検証手順を両OS向けに整備する
- 受け入れ条件:
  - Linux/FreeBSD の双方で起動・静的配信・CGI・HTTPS の基本シナリオが成功する
  - OS依存コードには分岐理由をコメントまたは設計書に明記する

### T8. セキュリティ・運用整備

- 実装内容:
  - リクエストサイズ上限、ヘッダサイズ上限、CGI実行タイムアウトを実装する
  - アクセスログ/エラーログを実装する（最低限: 時刻、メソッド、パス、ステータス、処理時間）
  - 起動手順・設定例・トラブルシュートをドキュメント化する
- 受け入れ条件:
  - 異常入力（巨大ヘッダ/ボディ）で過負荷にならず適切なエラー応答となる
  - 主要イベント（起動失敗、CGI失敗、TLS失敗）がログで追跡できる
  - ドキュメントだけで新規環境にセットアップできる

## 2. テスト計画（最小）

- 単体テスト:
  - 設定バリデータ、パス正規化、接続数カウンタ、CGI環境変数生成
- 結合テスト:
  - HTTP/HTTPS の静的配信、CGI `GET/POST`、異常系（不正設定・証明書不備・上限超過）
- 負荷テスト:
  - 100 同時接続での安定性、101 接続目の制御挙動
- 互換テスト:
  - Linux/FreeBSD で同一テストシナリオ実施

## 3. マイルストーン

1. M1: T1-T2 完了（HTTP/1.1 + 設定バリデーション）
2. M2: T3-T5 完了（HTTPS + 静的配信制約 + CGI）
3. M3: T6-T8 完了（同時接続制御 + OS互換 + 運用/セキュリティ）
