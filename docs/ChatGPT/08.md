**第8章：ファイル入出力とシステムとのやりとり**を見ていきましょう。



### **8. ファイル入出力とシステムとのやりとり**

ISLISPは、ファイルシステムや外部プログラムとやりとりするためのさまざまな関数を提供しています。これには、ファイルの読み書き、ファイルのメタデータの操作、出力ストリームの操作、オペレーティングシステムとのやりとりなどが含まれます。この章の各トピックを見ていきましょう。

#### **1. ファイルの読み書き (with-open-file)**

ISLISPはファイル操作を簡略化するマクロ `with-open-file` を提供しています。 このマクロは、ファイルのオープン、読み込み、クローズを自動的に処理し、リソースが適切に解放されるようにします。

##### **例: ファイルからの読み込み**

```lisp
(with-open-file (stream "example.txt" :direction :input)
  (let ((line (read-line stream nil)))
    (while line
      (format t "Read: ~A~%" line)
      (setf line (read-line stream nil)))))
```

- 上記の例では、マクロ `with-open-file` がファイル `example.txt` を読み取りモード (`:direction :input`) で開きます。
- `read-line` は、ファイルの終端に到達するまでファイルから行を読み取ります。
- `format` 関数は、各行を出力に表示するために使用されます。

##### **例: ファイルへの書き込み**

```lisp
(with-open-file (stream "output.txt" :direction :output :if-exists :overwrite)
  (write-line "This is a test" stream))
```

- ここでは、`with-open-file` が `output.txt` を書き込み用に開きます。
- `:if-exists : overwrite`オプションは、ファイルがすでに存在する場合、上書きすることを保証します。
- `write-line`は文字列をファイルに書き込みます。

#### **2. ファイルへのデータの追加**

データを上書きせずにファイルに追加するには、`:if-exists :append`オプションを使用できます。

##### **例: ファイルへの追加**

```lisp
(with-open-file (stream "output.txt" :direction :output :if-exists :append)
  (write-line "This is an appended line" stream))
```

- このコードは `output.txt` を追加用に開き、ファイルの内容を上書きせずに、ファイルの末尾に新しい行を追加します。

#### **3. ファイルの確認と削除 (`probe-file`, `delete-file`)**

ISLISPは、ファイルの存在をチェックし、削除する関数を提供します。

##### **例：ファイルの存在チェック (`probe-file`)**

```lisp
(if (probe-file "example.txt")
    (format t "File exists.")
    (format t "File does not exist."))
```

- `probe-file` は、ファイルが存在すればそのパス名を返し、存在しなければ `nil` を返します。 この関数を使用して、操作を実行する前にファイルが存在するかどうかを確認することができます。

##### **例: ファイルの削除 (`delete-file`)**

```lisp
(delete-file "example.txt")
```

- `delete-file` は指定されたファイルを削除します。 この操作は不可逆であるため、注意が必要です。

#### **4. ストリームと出力の印刷**

ISLISPにおけるストリームは、ファイル、ターミナル、その他のデバイスなどの入出力チャネルを表す抽象概念です。ストリームへの出力の印刷には、一般的に `format` 関数が使用されます。

##### **例: 標準出力への書き込み**

```lisp
(format t "Hello, World!")
```

- `t` 引数は標準出力（通常はターミナル）を参照します。これにより、コンソールに `"Hello, World!"` が表示されます。

##### **例：ファイルストリームへの書き込み**

```lisp
(with-open-file (stream "log.txt" :direction :output)
  (format stream "Log entry: ~A~%" (get-universal-time)))
```

- ここでは、`format` 関数を使用して、タイムスタンプをファイル `log.txt` に表示します。

#### **5. `format` によるテキストの書式設定**

`format` 関数は、ISLISP における出力制御のための最も強力なユーティリティのひとつです。 テキストや数値などの書式設定のためのさまざまな指示子をサポートしています。

##### **一般的な書式指示子:**

- `~A` - 美観を重視した表現 (プリティ・プリント)
- `~S` - 標準的な表現 (書き込み)
- `~%` - 改行
- `~D` - 整数の10進数形式
- `~F` - 浮動小数点数形式
- `~&` - 改行 (固定幅出力用)

##### **例: 書式指令の使用**

```lisp
(format t "A string: ~A, a number: ~D, and a float: ~F~%" "hello" 42 3.14159)
```

- これは以下のように表示されます。

  `A string: hello, a number: 42, and a float: 3.14159`

#### **6. シェルコマンドの実行 (`system`)**

ISLISPでは、オペレーティングシステムとやりとりする `system` 関数を使用して、シェルコマンドを実行することができます。

##### **例: シェルコマンドの実行**

```lisp
(system "echo Hello from ISLISP")
```

- このコマンドは「Hello from ISLISP」をターミナル（シェル）に送信します。 オペレーティング・システムに応じて、有効なシェル・コマンドをここに使用することができます。

#### **7. 環境変数の取得 (`getenv`)**

`getenv` 関数を使用して、環境変数（システム設定やユーザー構成など）にアクセスすることができます。

##### **例：環境変数の取得**

```lisp
(format t "Home directory: ~A~%" (getenv "HOME"))
```

- このコードは、`HOME` 環境変数の値を取得して表示します。 通常、この値は Unix ライクなシステムにおけるユーザのホームディレクトリへのパスを表します。



#### **ファイル入出力とシステムとのやりとりの主な概念のまとめ**

1. **ファイルの読み書き:**
   - ファイル入出力の処理には `with-open-file` を使用します。
   - `read-line` を使用してファイルを読み込み、`write-line` を使用してファイルに書き込みます。

2. **ファイルへのデータの追加:**
   - ファイルに追加するには、`with-open-file` の `:if-exists :append` オプションを使用します。

3. **ファイルの確認と削除:**
   - `probe-file` はファイルの存在をチェックし、`delete-file` はファイルを削除します。

4. **ストリームと出力の印刷:**
   - ISLISP は入出力操作にストリームを使用し、`format` はストリームに出力を印刷する標準的な方法です。

5. **`format` によるテキストのフォーマット:**
   - `format` を使用すると、テキスト、数値、その他のデータ型の印刷方法を制御できます。

6. **シェルコマンドの実行:**
   - `system` 関数を使用して、ISLISP 内からシェルコマンドを実行します。

7. **環境変数の取得:**
   - `getenv` 関数を使用すると、環境変数を取得でき、システム構成へのアクセスが可能になります。


